<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>許可證查詢工具</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      background-color: #f9f9f9;
    }
    label, select, input, button {
      font-size: 1rem;
      margin: 0.25rem;
    }
    input[type="number"] {
      width: 6rem;
    }
    table {
      margin-top: 1rem;
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: left;
    }
  </style>
</head>
<body>
  <h2>許可證字號查詢工具</h2>

  <div>
    <label>機關別：</label>
    <select id="agency">
      <option value="衛部">衛部</option>
      <option value="衛署">衛署</option>
    </select>

    <label>類別：</label>
    <select id="type">
      <option value="製">製造</option>
      <option value="輸">輸入</option>
      <option value="陸輸">陸輸</option>
    </select>

    <label>等級：</label>
    <select id="level">
      <option value="壹登">登錄</option>
      <option value="壹" selected>第一等級</option>
      <option value="">第二三等級</option>
    </select>

    <label>號碼：</label>
    <input type="number" id="number" placeholder="123456" />
    <br/>
    <label>廠商來文日期：</label>
    <input type="date" id="submitDate" />
    <label>廠商來文字號：</label>
    <input type="text" id="submitName" />
    <label>母文文號：</label>
    <input type="number" id="docNum" />
    <label>收據編號：</label>
    <input type="text" id="receiptNumber" />
    
    
    
    <button onclick="buildAndSearch()">查詢</button>
    <button onclick="buildExtendDoc()">產生展延案文稿</button>
  </div>

  <p><strong>完整許可證字號：</strong><span id="fullLicense"></span></p>

  <div id="result"></div>

  <script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTOJR30cTwoZzjlFDJfks9u_4RNe5jjyceMVMnetuWsvUgYSZAYuKFOZqvRfrTbejHs8H31YDoIc2iX/pub?gid=1411787074&single=true&output=tsv';
    let csvData = [];

    async function fetchCSV() {
      const response = await fetch(csvUrl);
      const text = await response.text();
      const rows = text.trim().split('\n').map(row => row.split('\t'));
      csvData = rows;
    }

    function padNumber(num) {
      return num.toString().padStart(6, '0');
    }

    function toROCDate(westernDateStr) {
      if (!westernDateStr) return '';
    
      const [year, month, day] = westernDateStr.split('/').map(Number);
      if (isNaN(year) || isNaN(month) || isNaN(day)) return '';
    
      const rocYear = year - 1911;
      return `${rocYear}年${month}月${day}日`;
    }
    function addFiveYears(dateStr) {
      if (!dateStr) return '';
    
      const [year, month, day] = dateStr.split('/').map(Number);
      if (isNaN(year) || isNaN(month) || isNaN(day)) return '';
    
      const newYear = year + 5;
      return `${newYear}/${String(month).padStart(2, '0')}/${String(day).padStart(2, '0')}`;
    }


    function buildExtendDoc() {
      const agency = document.getElementById('agency').value;     // 衛部 or 衛署
      const type = document.getElementById('type').value;         // 製、輸、陸輸
      const level = document.getElementById('level').value;       // 壹登、壹、空白
      const number = document.getElementById('number').value;
      const submitDate = document.getElementById('submitDate').value.replaceAll("-","/"); //廠商發文日期
      const submitDoc = document.getElementById('submitName').value; //廠商發文字號
      const docNum = document.getElementById('docNum').value; //文號
      let receiptNumber = document.getElementById('receiptNumber').value; //收據編號
      
      if (!number || isNaN(number)) {
        alert('請輸入有效的號碼（六位數）');
        return;
      }

      if isNaN(receiptNumber){
        receiptNumber = "正本1份";
      }else{
        receiptNumber = `及編號${receiptNumber}繳款收據正本各1份`;
      }
      
      const paddedNumber = padNumber(number);
      const license = `${agency}醫器${type}${level}字第${paddedNumber}號`;
      document.getElementById('fullLicense').textContent = license;
      const header = csvData[0];
      const resultRow = csvData.find((row, index) => index !== 0 && row[0].trim() === license);
      var Lic = {};
      for (x = 0; x<header.length; x++){
        Lic[header[x]] = resultRow[x];
      }
      let html = `<p class="Main">主旨：有關${Lic["申請商名稱"]}申請「${Lic["中文品名"]}（${Lic["許可證字號"]}）」醫療器材許可證（下稱本許可證）展延一案，准予展延，復請查照。</p>`;
      html += `說明：`;
      html += `<p class="Content">一、復貴公司${toROCDate(submitDate)}許可證展延申請書，依醫療器材管理法第27條第1項規定申請許可證展延案（案號：${docNum}）辦理。</p>`;
      html += `<p class="Content">二、本許可證准予展延有效期限至${toROCDate(addFiveYears(Lic["有效日期"]))}。</p>`;
      html += `<p class="Content">三、隨函檢還本許可證${receiptNumber}。</p>`;
      html += `<p class="Content">四、附註：</p>`;
      html += `<p class="Content"> （一）受處分人如對本處分不服，得依訴願法第14條第1項、第58條第1項規定，自本函送達之次日起30日內，檢送訴願書至本部，由本部層轉訴願管轄機關行政院提起訴願。</p>`;
      html += `<p class="Content"> （二）訴願人繕具訴願書，應載明第56條第1項所列事項，由訴願人或代理人簽名或蓋章；並依同條第2項規定，檢附本函影本。</p>`;
      document.getElementById('result').innerHTML = html;
    }

    function buildAndSearch() {
      const agency = document.getElementById('agency').value;     // 衛部 or 衛署
      const type = document.getElementById('type').value;         // 製、輸、陸輸
      const level = document.getElementById('level').value;       // 壹登、壹、空白
      const number = document.getElementById('number').value;

      if (!number || isNaN(number)) {
        alert('請輸入有效的號碼（六位數）');
        return;
      }

      const paddedNumber = padNumber(number);
      const license = `${agency}醫器${type}${level}字第${paddedNumber}號`;

      document.getElementById('fullLicense').textContent = license;

      searchLicense(license);
    }

    function searchLicense(licenseNumber) {
      const header = csvData[0];
      const resultRow = csvData.find((row, index) => index !== 0 && row[0].trim() === licenseNumber);
      var Lic = {};
      for (x = 0; x<header.length; x++){
        Lic[header[x]] = resultRow[x]
      }
      
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = '';

      if (resultRow) {
        let html = '<table><thead><tr>';
        header.forEach(col => html += `<th>${col}</th>`);
        html += '</tr></thead><tbody><tr>';
        resultRow.forEach(cell => html += `<td>${cell}</td>`);
        html += '</tr></tbody></table>';
        resultDiv.innerHTML = html;
      } else {
        resultDiv.textContent = '查無資料';
      }
    }

    // 初始化 CSV 資料
    fetchCSV();
  </script>
</body>
</html>
